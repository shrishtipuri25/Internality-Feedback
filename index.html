<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Internality — Feedback</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #000000;
    --paper: #F3EFE5;
    --gold: #C1B07F;
    --gold-light: #d4c99a;
    --blue: #1D3D9A;
    --blue-dark: #1B1464;
    --mint: #6FEEBE;
    --muted: #6b6860;
    --border: #ddd8cc;
    --surface: #ffffff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'Montserrat', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }
  .view { display: none; }
  .view.active { display: block; }

  header {
    border-bottom: 1px solid var(--border);
    padding: 28px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--blue);
  }
  .logo {
    font-family: 'Source Serif 4', serif;
    font-size: 22px;
    font-weight: 600;
    letter-spacing: 0.04em;
    color: var(--paper);
  }
  .logo span { color: #ffffff; }
  .logo em { color: var(--gold) !important; font-style: italic; }
  .admin-link {
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(243,239,229,0.7);
    cursor: pointer;
    border: none;
    background: none;
    font-family: 'Montserrat', sans-serif;
    transition: color 0.2s;
  }
  .admin-link:hover { color: var(--mint); }

  .form-container {
    max-width: 680px;
    margin: 80px auto;
    padding: 0 24px;
  }
  .form-header { margin-bottom: 60px; }
  .form-header h1 {
    font-family: 'Source Serif 4', serif;
    font-size: clamp(36px, 5vw, 54px);
    font-weight: 300;
    line-height: 1.15;
    margin-bottom: 16px;
  }
  .form-header h1 em { font-style: italic; color: var(--blue); }
  .form-header p { color: var(--muted); font-size: 15px; line-height: 1.7; max-width: 480px; }
  .divider { width: 48px; height: 2px; background: var(--blue); margin: 24px 0; }

  .question-block {
    margin-bottom: 48px;
    animation: fadeUp 0.5s ease both;
  }
  .question-block:nth-child(2) { animation-delay: 0.1s; }
  .question-block:nth-child(3) { animation-delay: 0.2s; }
  .question-block:nth-child(4) { animation-delay: 0.3s; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .q-label {
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--blue);
    margin-bottom: 10px;
    font-weight: 500;
  }
  .q-text {
    font-family: 'Source Serif 4', serif;
    font-size: 22px;
    font-weight: 400;
    line-height: 1.4;
    margin-bottom: 20px;
    color: var(--ink);
  }

  .scale-group { display: flex; gap: 10px; margin-bottom: 8px; }
  .scale-btn {
    width: 44px; height: 44px;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: 2px;
    font-family: 'Montserrat', sans-serif;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--ink);
  }
  .scale-btn:hover { border-color: var(--blue); color: var(--blue); }
  .scale-btn.selected { background: var(--blue); border-color: var(--blue); color: white; }
  .scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.05em;
    padding: 0 2px;
    max-width: 254px;
  }

  textarea {
    width: 100%;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: 2px;
    padding: 16px 18px;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 300;
    color: var(--ink);
    resize: vertical;
    min-height: 100px;
    transition: border-color 0.2s;
    line-height: 1.7;
  }
  textarea:focus { outline: none; border-color: var(--blue); }
  textarea::placeholder { color: var(--muted); }
  .optional-comment { margin-top: 14px; }
  .optional-label { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }

  input[type="text"] {
    width: 100%;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: 2px;
    padding: 14px 18px;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 300;
    color: var(--ink);
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { outline: none; border-color: var(--blue); }
  input[type="text"]::placeholder { color: var(--muted); }

  .submit-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 16px 36px;
    font-family: 'Montserrat', sans-serif;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    margin-top: 16px;
    transition: background 0.2s;
  }
  .submit-btn:hover { background: var(--blue-dark); }
  .submit-btn:disabled { background: var(--muted); cursor: not-allowed; }
  .submit-btn .arrow { transition: transform 0.2s; }
  .submit-btn:hover:not(:disabled) .arrow { transform: translateX(4px); }

  .error-msg {
    margin-top: 12px;
    font-size: 13px;
    color: #c0392b;
    display: none;
  }

  .thankyou {
    text-align: center;
    padding: 80px 24px;
    max-width: 480px;
    margin: 0 auto;
  }
  .thankyou .check { font-size: 40px; margin-bottom: 24px; }
  .thankyou h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 36px;
    font-weight: 300;
    margin-bottom: 16px;
  }
  .thankyou p { color: var(--muted); line-height: 1.7; }

  /* ── ADMIN ── */
  .admin-container { max-width: 860px; margin: 0 auto; padding: 48px 24px; }
  .admin-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 48px; flex-wrap: wrap; gap: 16px;
  }
  .admin-header h2 {
    font-family: 'Source Serif 4', serif;
    font-size: 36px; font-weight: 300;
  }

  .setup-banner {
    background: #fffbf0;
    border: 1px solid #e8d5a0;
    border-radius: 2px;
    padding: 20px 24px;
    margin-bottom: 32px;
    font-size: 14px;
    line-height: 1.7;
  }
  .setup-banner strong { font-weight: 500; }
  .setup-banner a { color: var(--blue); text-decoration: underline; }
  .setup-url-row {
    display: flex; gap: 10px; align-items: center; margin-top: 12px;
  }
  .setup-url-input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 10px 14px;
    font-family: 'Montserrat', sans-serif;
    font-size: 13px;
    color: var(--ink);
    background: white;
  }
  .setup-url-input:focus { outline: none; border-color: var(--blue); }
  .connect-btn {
    background: var(--ink); color: white;
    border: none; padding: 10px 20px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px; letter-spacing: 0.1em;
    text-transform: uppercase; cursor: pointer;
    border-radius: 2px; transition: background 0.15s;
    white-space: nowrap;
  }
  .connect-btn:hover { background: var(--blue-dark); }
  .connected-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: #e8f5ee; border: 1px solid #a8d5b5;
    padding: 6px 12px; border-radius: 20px;
    font-size: 12px; color: #2d7a4f;
  }

  .tabs {
    display: flex; gap: 0;
    border: 1px solid var(--border); border-radius: 2px; overflow: hidden;
  }
  .tab-btn {
    padding: 10px 24px;
    background: var(--surface); border: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase;
    cursor: pointer; color: var(--muted); transition: all 0.15s;
    border-right: 1px solid var(--border);
  }
  .tab-btn:last-child { border-right: none; }
  .tab-btn.active { background: var(--ink); color: white; }

  .response-count { font-size: 13px; color: var(--muted); margin-bottom: 24px; }
  .response-count strong { color: var(--ink); font-weight: 500; }

  .response-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 2px; padding: 28px 32px; margin-bottom: 16px;
    animation: fadeUp 0.3s ease both;
  }
  .response-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
  }
  .respondent-name { font-family: 'Source Serif 4', serif; font-size: 20px; font-weight: 400; }
  .response-date { font-size: 12px; color: var(--muted); }
  .response-item { margin-bottom: 20px; }
  .response-q { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .response-a { font-size: 15px; line-height: 1.6; color: var(--ink); }
  .score-display { display: inline-flex; align-items: center; gap: 8px; }
  .score-num { font-family: 'Source Serif 4', serif; font-size: 28px; color: var(--blue); font-weight: 300; }
  .score-max { font-size: 13px; color: var(--muted); }

  .empty-state { text-align: center; padding: 64px 24px; color: var(--muted); }
  .empty-state .icon { font-size: 36px; margin-bottom: 16px; }
  .empty-state h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 24px; font-weight: 300; margin-bottom: 8px; color: var(--ink);
  }

  /* Questions editor */
  .question-editor {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 2px; padding: 32px; margin-bottom: 16px;
  }
  .question-editor-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
  }
  .q-num { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--blue); font-weight: 500; }
  .q-type-badge {
    font-size: 11px; background: var(--paper); border: 1px solid var(--border);
    padding: 4px 10px; border-radius: 20px; color: var(--muted); letter-spacing: 0.05em;
  }
  .editor-input {
    width: 100%; border: 1px solid var(--border); border-radius: 2px;
    padding: 12px 16px; font-family: 'Montserrat', sans-serif;
    font-size: 15px; font-weight: 300; color: var(--ink);
    transition: border-color 0.2s; background: var(--paper); margin-bottom: 12px;
  }
  .editor-input:focus { outline: none; border-color: var(--blue); background: white; }
  .type-select {
    border: 1px solid var(--border); border-radius: 2px; padding: 8px 12px;
    font-family: 'Montserrat', sans-serif; font-size: 13px; background: var(--paper); color: var(--ink); cursor: pointer;
  }
  .type-select:focus { outline: none; border-color: var(--blue); }
  .save-btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--ink); color: var(--paper); border: none;
    padding: 12px 28px; font-family: 'Montserrat', sans-serif;
    font-size: 12px; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase;
    cursor: pointer; border-radius: 2px; margin-top: 8px; transition: background 0.2s;
  }
  .save-btn:hover { background: var(--blue-dark); }
  .saved-msg {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 12px; color: #4a9e6b; margin-left: 16px;
    opacity: 0; transition: opacity 0.3s;
  }
  .saved-msg.show { opacity: 1; }

  .back-link {
    font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); cursor: pointer; border: none; background: none;
    font-family: 'Montserrat', sans-serif; transition: color 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .back-link:hover { color: var(--blue); }

  .export-btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: transparent; color: var(--ink); border: 1px solid var(--border);
    padding: 10px 20px; font-family: 'Montserrat', sans-serif;
    font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase;
    cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .export-btn:hover { border-color: var(--blue); color: var(--blue); }

  @media (max-width: 600px) {
    header { padding: 20px 24px; }
    .form-container { margin: 48px auto; }
    .scale-group { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Internality</div>
  <button class="admin-link" onclick="showAdmin()">Admin ↗</button>
</header>

<!-- PASSWORD MODAL -->
<div id="password-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; display:none; align-items:center; justify-content:center;">
  <div style="background:var(--surface); border:1px solid var(--border); border-radius:2px; padding:40px; max-width:400px; width:90%; text-align:center;">
    <div style="font-family:'Source Serif 4',serif; font-size:24px; font-weight:300; margin-bottom:8px;" id="modal-title">Admin Access</div>
    <p style="font-size:13px; color:var(--muted); margin-bottom:24px;" id="modal-subtitle">Enter your password to continue.</p>
    <input type="password" id="password-input" placeholder="Password" style="width:100%; border:1px solid var(--border); border-radius:2px; padding:12px 16px; font-family:'Montserrat',sans-serif; font-size:14px; margin-bottom:8px; text-align:center; letter-spacing:0.1em;">
    <div id="password-error" style="font-size:12px; color:#c0392b; margin-bottom:12px; display:none;">Incorrect password. Try again.</div>
    <input type="password" id="password-confirm" placeholder="Confirm password" style="width:100%; border:1px solid var(--border); border-radius:2px; padding:12px 16px; font-family:'Montserrat',sans-serif; font-size:14px; margin-bottom:16px; text-align:center; letter-spacing:0.1em; display:none;">
    <button onclick="submitPassword()" style="width:100%; background:var(--blue); color:white; border:none; padding:14px; font-family:'Montserrat',sans-serif; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; border-radius:2px;">Continue →</button>
    <button onclick="closeModal()" style="margin-top:12px; background:none; border:none; font-size:12px; color:var(--muted); cursor:pointer; font-family:'Montserrat',sans-serif;">Cancel</button>
  </div>
</div>

<!-- FORM VIEW -->
<div id="view-form" class="view active">
  <div class="form-container">
    <div class="form-header">
      <div class="q-label" id="form-eyebrow"></div>
      <h1 id="form-headline"></h1>
      <div class="divider"></div>
      <p id="form-intro"></p>
    </div>

    <div class="question-block">
      <div class="q-label">Your Name <span style="color:#c0392b;">*</span></div>
      <input type="text" id="respondent-name" placeholder="Name & Title">
      <div id="name-error" style="display:none; font-size:12px; color:#c0392b; margin-top:6px;">Please enter your name to continue.</div>
    </div>

    <div id="questions-form"></div>

    <button class="submit-btn" id="submit-btn" onclick="submitForm()">
      Submit Feedback <span class="arrow">→</span>
    </button>
    <div class="error-msg" id="error-msg">Something went wrong. Please try again.</div>
  </div>
</div>

<!-- THANK YOU VIEW -->
<div id="view-thanks" class="view">
  <div class="thankyou">
    <div class="check">✦</div>
    <h2>Thank you.</h2>
    <p>Your feedback has been received and will help us build a more effective platform. We appreciate you taking the time.</p>
  </div>
</div>

<!-- ADMIN VIEW -->
<div id="view-admin" class="view">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <button class="back-link" onclick="showForm()">← Back to form</button>
        <h2 style="margin-top:12px">Admin Dashboard</h2>
      </div>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button class="export-btn" onclick="exportCSV()">↓ Export CSV</button>
        <div class="tabs">
          <button class="tab-btn active" id="tab-responses" onclick="switchTab('responses')">Responses</button>
          <button class="tab-btn" id="tab-content" onclick="switchTab('content')">Edit Content</button>
          <button class="tab-btn" id="tab-questions" onclick="switchTab('questions')">Edit Questions</button>
          <button class="tab-btn" id="tab-setup" onclick="switchTab('setup')">⚙ Setup</button>
        </div>
      </div>
    </div>

    <!-- RESPONSES PANEL -->
    <div id="panel-responses">
      <div class="response-count" id="response-count"></div>
      <div id="responses-list"></div>
    </div>

    <!-- CONTENT PANEL -->
    <div id="panel-content" style="display:none;">
      <div style="max-width:600px;">
        <div class="question-editor">
          <div class="question-editor-header">
            <div class="q-num">Eyebrow Label</div>
            <span class="q-type-badge">Small text above headline</span>
          </div>
          <input class="editor-input" id="content-eyebrow" placeholder="e.g. Internality Website">
        </div>
        <div class="question-editor">
          <div class="question-editor-header">
            <div class="q-num">Headline</div>
            <span class="q-type-badge">Main heading</span>
          </div>
          <input class="editor-input" id="content-headline" placeholder="e.g. We'd value your perspective.">
        </div>
        <div class="question-editor">
          <div class="question-editor-header">
            <div class="q-num">Intro Text</div>
            <span class="q-type-badge">Paragraph below headline</span>
          </div>
          <textarea class="editor-input" id="content-intro" rows="3" style="resize:vertical;" placeholder="e.g. Three brief questions about our website…"></textarea>
        </div>
        <div class="question-editor">
          <div class="question-editor-header">
            <div class="q-num">Thank You Message</div>
            <span class="q-type-badge">Shown after submission</span>
          </div>
          <textarea class="editor-input" id="content-thankyou" rows="3" style="resize:vertical;" placeholder="e.g. Your feedback has been received…"></textarea>
        </div>
        <button class="save-btn" onclick="saveContent()">Save Content</button>
        <span class="saved-msg" id="saved-content-msg">✓ Saved</span>
      </div>
    </div>

    <!-- QUESTIONS PANEL -->
    <div id="panel-questions" style="display:none;">
      <div id="questions-editor"></div>
      <button class="save-btn" onclick="saveQuestions()">Save Questions</button>
      <span class="saved-msg" id="saved-msg">✓ Saved</span>
    </div>

    <!-- SETUP PANEL -->
    <div id="panel-setup" style="display:none;">
      <div style="max-width:600px;">
        <div class="setup-banner">
          <strong>Connect to Google Sheets</strong><br><br>
          Follow these steps once to get your responses automatically saved to a Google Sheet:<br><br>
          <strong>1.</strong> Open <a href="https://sheets.google.com" target="_blank">Google Sheets</a> and create a new spreadsheet.<br>
          <strong>2.</strong> Click <strong>Extensions → Apps Script</strong>.<br>
          <strong>3.</strong> Delete all existing code and paste in the contents of <code>google-apps-script.js</code>.<br>
          <strong>4.</strong> Click <strong>Deploy → New deployment → Web app</strong>.<br>
          <strong>5.</strong> Set "Who has access" to <strong>Anyone</strong>. Click Deploy and authorize.<br>
          <strong>6.</strong> Copy the Web App URL and paste it below.
        </div>

        <div id="connection-status"></div>

        <div class="setup-url-row">
          <input class="setup-url-input" id="sheets-url" placeholder="https://script.google.com/macros/s/…/exec" />
          <button class="connect-btn" onclick="saveSheetURL()">Connect</button>
        </div>
        <p style="font-size:12px; color:var(--muted); margin-top:10px;">This URL is stored in your browser and never shared.</p>
        <div style="margin-top:32px; padding-top:24px; border-top:1px solid var(--border);">
          <div class="q-num" style="margin-bottom:12px;">Change Admin Password</div>
          <div class="setup-url-row">
            <input type="password" class="setup-url-input" id="new-password" placeholder="New password" />
            <button class="connect-btn" onclick="changePassword()">Update</button>
          </div>
          <div id="pw-change-msg" style="font-size:12px; color:#2d7a4f; margin-top:8px; display:none;">✓ Password updated</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ── CONFIG — paste your Apps Script URL here OR enter it in Admin → Setup ──
const HARDCODED_URL = ""; // Optional: paste URL directly here

// ── DEFAULT QUESTIONS ──
const DEFAULT_QUESTIONS = [
  { id: 'q1', text: 'How clearly did the platform communicate its value to your organization?', type: 'scale', scaleMin: 'Not at all clear', scaleMax: 'Extremely clear' },
  { id: 'q2', text: 'What, if anything, was unclear or missing from what you saw?', type: 'text' },
  { id: 'q3', text: 'How likely are you to explore Internality further?', type: 'scale', scaleMin: 'Not likely', scaleMax: 'Very likely' }
];

// ── STATE ──
let questions = loadQuestions();
let responses = loadResponses();
let formAnswers = {};

function getSheetURL() {
  return HARDCODED_URL || localStorage.getItem('internality_sheet_url') || '';
}
function loadQuestions() {
  try { const s = localStorage.getItem('internality_questions'); return s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_QUESTIONS)); } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_QUESTIONS)); }
}
function loadResponses() {
  try { const s = localStorage.getItem('internality_responses'); return s ? JSON.parse(s) : []; } catch(e) { return []; }
}
function saveResponsesToStorage() {
  try { localStorage.setItem('internality_responses', JSON.stringify(responses)); } catch(e) {}
}

// ── RENDER FORM ──
function renderForm() {
  const container = document.getElementById('questions-form');
  container.innerHTML = '';
  formAnswers = {};
  questions.forEach((q, i) => {
    const block = document.createElement('div');
    block.className = 'question-block';
    block.style.animationDelay = (i * 0.1 + 0.1) + 's';
    let inputHTML = '';
    if (q.type === 'scale') {
      let btns = '';
      for (let n = 1; n <= 5; n++) {
        btns += `<button class="scale-btn" data-q="${q.id}" data-val="${n}" onclick="selectScale('${q.id}', ${n}, this)">${n}</button>`;
      }
      inputHTML = `
        <div class="scale-group">${btns}</div>
        <div class="scale-labels" style="max-width:${5*44+4*10}px">
          <span>${q.scaleMin || 'Low'}</span><span>${q.scaleMax || 'High'}</span>
        </div>
        <div class="optional-comment">
          <div class="optional-label">Comment (optional)</div>
          <textarea placeholder="Any additional thoughts…" oninput="formAnswers['${q.id}_comment']=this.value" rows="3"></textarea>
        </div>`;
    } else {
      inputHTML = `<textarea placeholder="Your response…" oninput="formAnswers['${q.id}']=this.value" rows="4"></textarea>`;
    }
    block.innerHTML = `<div class="q-label">Question ${i + 1}</div><div class="q-text">${q.text}</div>${inputHTML}`;
    container.appendChild(block);
  });
}

function selectScale(qId, val, btn) {
  formAnswers[qId] = val;
  document.querySelectorAll(`[data-q="${qId}"]`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// ── SUBMIT ──
async function submitForm() {
  const name = document.getElementById('respondent-name').value.trim();
  const nameError = document.getElementById('name-error');

  if (!name) {
    nameError.style.display = 'block';
    document.getElementById('respondent-name').focus();
    return;
  }
  nameError.style.display = 'none';
  const btn = document.getElementById('submit-btn');
  const errEl = document.getElementById('error-msg');
  errEl.style.display = 'none';

  const payload = { name };
  questions.forEach(q => {
    if (q.type === 'scale') {
      payload[`${q.id}_score`] = formAnswers[q.id] || null;
      payload[`${q.id}_comment`] = formAnswers[q.id + '_comment'] || '';
    } else {
      payload[`${q.id}_text`] = formAnswers[q.id] || '';
    }
  });

  // Save locally too (fallback)
  const entry = { name, date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }), answers: {} };
  questions.forEach(q => {
    if (q.type === 'scale') entry.answers[q.id] = { score: formAnswers[q.id] || null, comment: formAnswers[q.id + '_comment'] || '' };
    else entry.answers[q.id] = { text: formAnswers[q.id] || '' };
  });
  responses.push(entry);
  saveResponsesToStorage();

  // Send to Google Sheets if URL is configured
  const url = getSheetURL();
  if (url) {
    btn.disabled = true;
    btn.textContent = 'Sending…';
    try {
      await fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch(e) {
      console.warn('Sheet sync failed:', e);
    }
    btn.disabled = false;
    btn.innerHTML = 'Submit Feedback <span class="arrow">→</span>';
  }

  showView('view-thanks');
}

// ── ADMIN RESPONSES ──
function renderResponses() {
  const list = document.getElementById('responses-list');
  const count = document.getElementById('response-count');
  const sheetConnected = !!getSheetURL();
  count.innerHTML = `<strong>${responses.length}</strong> response${responses.length !== 1 ? 's' : ''} stored locally${sheetConnected ? ' · <span style="color:#2d7a4f">✓ Google Sheets connected</span>' : ' · <span style="color:var(--muted)">Google Sheets not connected</span>'}`;
  if (!responses.length) {
    list.innerHTML = `<div class="empty-state"><div class="icon">✦</div><h3>No responses yet</h3><p>Responses will appear here once people submit feedback.</p></div>`;
    return;
  }
  list.innerHTML = '';
  [...responses].reverse().forEach(r => {
    const card = document.createElement('div');
    card.className = 'response-card';
    let answersHTML = '';
    questions.forEach(q => {
      const a = r.answers[q.id];
      if (!a) return;
      let aHTML = '';
      if (q.type === 'scale') {
        aHTML = `<div class="score-display"><span class="score-num">${a.score || '—'}</span><span class="score-max">/ 5</span></div>`;
        if (a.comment) aHTML += `<div style="margin-top:8px;font-size:14px;color:var(--muted)">${a.comment}</div>`;
      } else {
        aHTML = `<div>${a.text || '<span style="color:var(--muted)">No response</span>'}</div>`;
      }
      answersHTML += `<div class="response-item"><div class="response-q">${q.text}</div><div class="response-a">${aHTML}</div></div>`;
    });
    card.innerHTML = `<div class="response-card-header"><div class="respondent-name">${r.name}</div><div class="response-date">${r.date}</div></div>${answersHTML}`;
    list.appendChild(card);
  });
}

// ── EXPORT CSV ──
function exportCSV() {
  if (!responses.length) { alert('No responses to export yet.'); return; }
  const headers = ['Name', 'Date', ...questions.map((q, i) => `Q${i+1}: ${q.text}`)];
  const rows = [headers.map(h => `"${h}"`).join(',')];
  responses.forEach(r => {
    const cols = [`"${r.name}"`, `"${r.date}"`];
    questions.forEach(q => {
      const a = r.answers[q.id] || {};
      if (q.type === 'scale') cols.push(`"${a.score || ''} — ${(a.comment || '').replace(/"/g, '""')}"`);
      else cols.push(`"${(a.text || '').replace(/"/g, '""')}"`);
    });
    rows.push(cols.join(','));
  });
  const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'internality-feedback.csv';
  a.click();
}

// ── DEFAULT CONTENT ──
const DEFAULT_CONTENT = {
  eyebrow: 'Internality Website',
  headline: "We'd value your perspective.",
  intro: 'Three brief questions about our website. Your input helps us communicate more effectively.',
  thankyou: 'Your feedback has been received. We appreciate you taking the time.'
};

function loadContent() {
  try { const s = localStorage.getItem('internality_content'); return s ? JSON.parse(s) : { ...DEFAULT_CONTENT }; } catch(e) { return { ...DEFAULT_CONTENT }; }
}
let pageContent = loadContent();

function renderFormHeader() {
  document.getElementById('form-eyebrow').textContent = pageContent.eyebrow;
  document.getElementById('form-headline').innerHTML = pageContent.headline;
  document.getElementById('form-intro').textContent = pageContent.intro;
}

function renderContentEditor() {
  document.getElementById('content-eyebrow').value = pageContent.eyebrow;
  document.getElementById('content-headline').value = pageContent.headline;
  document.getElementById('content-intro').value = pageContent.intro;
  document.getElementById('content-thankyou').value = pageContent.thankyou;
}

function saveContent() {
  pageContent.eyebrow = document.getElementById('content-eyebrow').value;
  pageContent.headline = document.getElementById('content-headline').value;
  pageContent.intro = document.getElementById('content-intro').value;
  pageContent.thankyou = document.getElementById('content-thankyou').value;
  try { localStorage.setItem('internality_content', JSON.stringify(pageContent)); } catch(e) {}
  renderFormHeader();
  document.getElementById('view-thanks').querySelector('p').textContent = pageContent.thankyou;
  const msg = document.getElementById('saved-content-msg');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2500);
}


function renderQuestionsEditor() {
  const container = document.getElementById('questions-editor');
  container.innerHTML = '';
  questions.forEach((q, i) => {
    const div = document.createElement('div');
    div.className = 'question-editor';
    div.innerHTML = `
      <div class="question-editor-header">
        <div class="q-num">Question ${i + 1}</div>
        <span class="q-type-badge" id="type-badge-${i}">${q.type === 'scale' ? '1–5 Scale' : 'Open text'}</span>
      </div>
      <input class="editor-input" id="q-text-${i}" value="${q.text.replace(/"/g,'&quot;')}" placeholder="Question text…">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <select class="type-select" id="q-type-${i}" onchange="updateTypeBadge(${i})">
          <option value="scale" ${q.type==='scale'?'selected':''}>Scale (1–5)</option>
          <option value="text" ${q.type==='text'?'selected':''}>Open text</option>
        </select>
        ${q.type==='scale'?`
        <input class="editor-input" id="q-min-${i}" style="flex:1;margin-bottom:0;" value="${(q.scaleMin||'').replace(/"/g,'&quot;')}" placeholder="Label: low end">
        <input class="editor-input" id="q-max-${i}" style="flex:1;margin-bottom:0;" value="${(q.scaleMax||'').replace(/"/g,'&quot;')}" placeholder="Label: high end">
        `:''}
      </div>`;
    container.appendChild(div);
  });
}
function updateTypeBadge(i) {
  collectEditorValues();
  renderQuestionsEditor();
}
function collectEditorValues() {
  questions.forEach((q, i) => {
    const t = document.getElementById(`q-text-${i}`);
    const ty = document.getElementById(`q-type-${i}`);
    if (t) q.text = t.value;
    if (ty) q.type = ty.value;
    if (q.type === 'scale') {
      const mn = document.getElementById(`q-min-${i}`);
      const mx = document.getElementById(`q-max-${i}`);
      if (mn) q.scaleMin = mn.value;
      if (mx) q.scaleMax = mx.value;
    }
  });
}
function saveQuestions() {
  collectEditorValues();
  try { localStorage.setItem('internality_questions', JSON.stringify(questions)); } catch(e) {}
  renderForm();
  const msg = document.getElementById('saved-msg');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2500);
}

// ── SETUP ──
function renderSetup() {
  const url = getSheetURL();
  const statusEl = document.getElementById('connection-status');
  const inputEl = document.getElementById('sheets-url');
  if (url) {
    inputEl.value = url;
    statusEl.innerHTML = `<div class="connected-badge" style="margin-bottom:16px;">✓ Connected to Google Sheets</div>`;
  } else {
    statusEl.innerHTML = '';
  }
}
function saveSheetURL() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) return;
  localStorage.setItem('internality_sheet_url', url);
  renderSetup();
}

// ── PASSWORD ──
function getStoredPassword() {
  try { return localStorage.getItem('internality_admin_pw') || ''; } catch(e) { return ''; }
}
function showAdmin() {
  const stored = getStoredPassword();
  const modal = document.getElementById('password-modal');
  const title = document.getElementById('modal-title');
  const subtitle = document.getElementById('modal-subtitle');
  const confirm = document.getElementById('password-confirm');
  const input = document.getElementById('password-input');
  document.getElementById('password-error').style.display = 'none';
  input.value = '';
  confirm.value = '';

  if (!stored) {
    // First time — set a password
    title.textContent = 'Set Admin Password';
    subtitle.textContent = 'Choose a password to protect your admin panel.';
    confirm.style.display = 'block';
  } else {
    title.textContent = 'Admin Access';
    subtitle.textContent = 'Enter your password to continue.';
    confirm.style.display = 'none';
  }
  modal.style.display = 'flex';
  setTimeout(() => input.focus(), 100);
}
function submitPassword() {
  const stored = getStoredPassword();
  const input = document.getElementById('password-input').value;
  const confirm = document.getElementById('password-confirm').value;
  const errEl = document.getElementById('password-error');

  if (!stored) {
    // Setting password for first time
    if (!input) { errEl.textContent = 'Please enter a password.'; errEl.style.display = 'block'; return; }
    if (input !== confirm) { errEl.textContent = 'Passwords do not match.'; errEl.style.display = 'block'; return; }
    try { localStorage.setItem('internality_admin_pw', input); } catch(e) {}
    closeModal();
    openAdmin();
  } else {
    if (input !== stored) { errEl.textContent = 'Incorrect password. Try again.'; errEl.style.display = 'block'; document.getElementById('password-input').value = ''; return; }
    closeModal();
    openAdmin();
  }
}
function closeModal() {
  document.getElementById('password-modal').style.display = 'none';
}
function openAdmin() {
  renderResponses();
  renderQuestionsEditor();
  renderSetup();
  renderContentEditor();
  showView('view-admin');
}
// Allow Enter key in password modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && document.getElementById('password-modal').style.display === 'flex') {
    submitPassword();
  }
});


function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function changePassword() {
  const newPw = document.getElementById('new-password').value.trim();
  if (!newPw) return;
  try { localStorage.setItem('internality_admin_pw', newPw); } catch(e) {}
  document.getElementById('new-password').value = '';
  const msg = document.getElementById('pw-change-msg');
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 2500);
}

function showForm() {
  renderForm();
  showView('view-form');
}
function switchTab(tab) {
  ['responses','content','questions','setup'].forEach(t => {
    document.getElementById(`panel-${t}`).style.display = t === tab ? 'block' : 'none';
    document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
  });
  if (tab === 'questions') renderQuestionsEditor();
  if (tab === 'responses') renderResponses();
  if (tab === 'setup') renderSetup();
  if (tab === 'content') renderContentEditor();
}

// ── INIT ──
renderFormHeader();
renderForm();
</script>
</body>
</html>
