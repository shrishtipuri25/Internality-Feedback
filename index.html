<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Internality — Feedback</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #000000;
  --paper: #F3EFE5;
  --gold: #C1B07F;
  --blue: #1D3D9A;
  --blue-dark: #1B1464;
  --mint: #6FEEBE;
  --muted: #6b6860;
  --border: #ddd8cc;
  --surface: #ffffff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--paper); color: var(--ink); font-family: 'Montserrat', sans-serif; font-weight: 300; min-height: 100vh; }

.view { display: none; }
.view.active { display: block; }

header { background: var(--blue); padding: 24px 48px; display: flex; align-items: center; justify-content: space-between; }
.logo { font-family: 'Source Serif 4', serif; font-size: 22px; font-weight: 600; color: #fff; letter-spacing: 0.02em; }
.admin-btn { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.6); cursor: pointer; border: none; background: none; font-family: 'Montserrat', sans-serif; transition: color 0.2s; }
.admin-btn:hover { color: var(--mint); }

.form-wrap { max-width: 660px; margin: 72px auto; padding: 0 24px; }
.form-eyebrow { font-size: 11px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--blue); font-weight: 500; margin-bottom: 12px; }
.form-headline { font-family: 'Source Serif 4', serif; font-size: clamp(32px,5vw,50px); font-weight: 300; line-height: 1.2; margin-bottom: 16px; }
.form-headline em { font-style: italic; color: var(--blue); }
.divider { width: 40px; height: 2px; background: var(--blue); margin: 20px 0; }
.form-intro { color: var(--muted); font-size: 14px; line-height: 1.8; max-width: 460px; margin-bottom: 48px; }

.q-block { margin-bottom: 40px; }
.q-num { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--blue); font-weight: 500; margin-bottom: 8px; }
.q-text { font-family: 'Source Serif 4', serif; font-size: 20px; font-weight: 400; line-height: 1.4; margin-bottom: 16px; }

input[type="text"], input[type="password"], textarea {
  width: 100%; border: 1px solid var(--border); border-radius: 2px;
  padding: 13px 16px; font-family: 'Montserrat', sans-serif; font-size: 14px;
  font-weight: 300; color: var(--ink); background: var(--surface); transition: border-color 0.2s;
}
input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: var(--blue); }
input[type="text"]::placeholder, input[type="password"]::placeholder, textarea::placeholder { color: var(--muted); }
textarea { resize: vertical; line-height: 1.7; }

.scale-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.scale-btn { width: 44px; height: 44px; border: 1px solid var(--border); border-radius: 2px; background: var(--surface); font-family: 'Montserrat', sans-serif; font-size: 15px; cursor: pointer; transition: all 0.15s; color: var(--ink); }
.scale-btn:hover { border-color: var(--blue); color: var(--blue); }
.scale-btn.selected { background: var(--blue); border-color: var(--blue); color: #fff; }
.scale-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); max-width: 264px; padding: 0 2px; }
.opt-label { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin: 12px 0 6px; }

.field-error { font-size: 12px; color: #c0392b; margin-top: 6px; display: none; }

.submit-btn { display: inline-flex; align-items: center; gap: 10px; background: var(--ink); color: var(--paper); border: none; padding: 15px 34px; font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; border-radius: 2px; margin-top: 8px; transition: background 0.2s; }
.submit-btn:hover { background: var(--blue); }
.submit-btn:disabled { background: var(--muted); cursor: not-allowed; }

.thankyou { text-align: center; padding: 100px 24px; max-width: 480px; margin: 0 auto; }
.thankyou .mark { font-size: 36px; margin-bottom: 20px; color: var(--blue); }
.thankyou h2 { font-family: 'Source Serif 4', serif; font-size: 36px; font-weight: 300; margin-bottom: 16px; }
.thankyou p { color: var(--muted); line-height: 1.8; font-size: 15px; }

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 200; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 44px 40px; max-width: 380px; width: 90%; text-align: center; }
.modal-box h3 { font-family: 'Source Serif 4', serif; font-size: 26px; font-weight: 300; margin-bottom: 8px; }
.modal-box p { font-size: 13px; color: var(--muted); margin-bottom: 24px; line-height: 1.6; }
.modal-input { width: 100%; border: 1px solid var(--border); border-radius: 2px; padding: 13px 16px; font-family: 'Montserrat', sans-serif; font-size: 14px; text-align: center; letter-spacing: 0.05em; margin-bottom: 10px; transition: border-color 0.2s; }
.modal-input:focus { outline: none; border-color: var(--blue); }
.modal-error { font-size: 12px; color: #c0392b; margin-bottom: 10px; min-height: 18px; }
.modal-submit { width: 100%; background: var(--blue); color: #fff; border: none; padding: 14px; font-family: 'Montserrat', sans-serif; font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; border-radius: 2px; margin-bottom: 10px; transition: background 0.2s; }
.modal-submit:hover { background: var(--blue-dark); }
.modal-cancel { font-size: 12px; color: var(--muted); cursor: pointer; border: none; background: none; font-family: 'Montserrat', sans-serif; }

/* ADMIN */
.admin-wrap { max-width: 880px; margin: 0 auto; padding: 48px 24px; }
.admin-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 40px; }
.admin-top h2 { font-family: 'Source Serif 4', serif; font-size: 34px; font-weight: 300; margin-top: 8px; }
.back-btn { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); cursor: pointer; border: none; background: none; font-family: 'Montserrat', sans-serif; }
.back-btn:hover { color: var(--blue); }
.admin-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.tabs { display: flex; border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
.tab { padding: 10px 18px; background: var(--surface); border: none; border-right: 1px solid var(--border); font-family: 'Montserrat', sans-serif; font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; color: var(--muted); transition: all 0.15s; }
.tab:last-child { border-right: none; }
.tab.active { background: var(--blue); color: #fff; }
.export-btn { display: inline-flex; align-items: center; gap: 6px; background: transparent; color: var(--ink); border: 1px solid var(--border); padding: 10px 18px; font-family: 'Montserrat', sans-serif; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 2px; transition: all 0.15s; }
.export-btn:hover { border-color: var(--blue); color: var(--blue); }

.panel { display: none; }
.panel.active { display: block; }

.resp-count { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
.resp-count strong { color: var(--ink); }
.resp-card { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 28px 30px; margin-bottom: 14px; }
.resp-head { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
.resp-name { font-family: 'Source Serif 4', serif; font-size: 20px; }
.resp-date { font-size: 12px; color: var(--muted); }
.resp-item { margin-bottom: 18px; }
.resp-q { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; }
.resp-a { font-size: 14px; line-height: 1.6; }
.resp-score { font-family: 'Source Serif 4', serif; font-size: 30px; color: var(--blue); font-weight: 300; }
.empty { text-align: center; padding: 60px 24px; color: var(--muted); }
.empty h3 { font-family: 'Source Serif 4', serif; font-size: 22px; font-weight: 300; color: var(--ink); margin: 12px 0 8px; }

.editor-card { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 24px 28px; margin-bottom: 14px; }
.editor-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.editor-label { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--blue); font-weight: 500; }
.editor-badge { font-size: 11px; background: var(--paper); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; color: var(--muted); }
.editor-input { width: 100%; border: 1px solid var(--border); border-radius: 2px; padding: 11px 14px; font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 300; color: var(--ink); background: var(--paper); margin-bottom: 10px; transition: border-color 0.2s; }
.editor-input:focus { outline: none; border-color: var(--blue); background: #fff; }
.type-select { border: 1px solid var(--border); border-radius: 2px; padding: 8px 12px; font-family: 'Montserrat', sans-serif; font-size: 13px; background: var(--paper); color: var(--ink); cursor: pointer; }
.type-select:focus { outline: none; border-color: var(--blue); }
.q-actions { display: flex; align-items: center; gap: 6px; }
.icon-btn { background: none; border: 1px solid var(--border); border-radius: 2px; width: 30px; height: 30px; cursor: pointer; font-size: 13px; color: var(--muted); display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s; }
.icon-btn:hover { border-color: var(--blue); color: var(--blue); }
.icon-btn.del { border-color: #e0b0b0; color: #c0392b; }
.icon-btn.del:hover { background: #fdf0f0; }

.add-q-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; background: transparent; color: var(--blue); border: 1px dashed var(--blue); padding: 14px; font-family: 'Montserrat', sans-serif; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border-radius: 2px; transition: all 0.15s; margin-top: 4px; }
.add-q-btn:hover { background: #f0f4ff; }

.save-btn { display: inline-flex; align-items: center; gap: 8px; background: var(--ink); color: var(--paper); border: none; padding: 12px 28px; font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; border-radius: 2px; margin-top: 16px; transition: background 0.2s; }
.save-btn:hover { background: var(--blue); }
.saved-msg { font-size: 12px; color: #2d7a4f; margin-left: 14px; opacity: 0; transition: opacity 0.3s; }
.saved-msg.show { opacity: 1; }

.setup-banner { background: #fffbf0; border: 1px solid #e8d5a0; border-radius: 2px; padding: 20px 24px; margin-bottom: 20px; font-size: 14px; line-height: 1.8; }
.setup-banner strong { font-weight: 500; }
.setup-banner a { color: var(--blue); }
.setup-row { display: flex; gap: 10px; align-items: center; }
.setup-input { flex: 1; border: 1px solid var(--border); border-radius: 2px; padding: 10px 14px; font-family: 'Montserrat', sans-serif; font-size: 13px; color: var(--ink); background: #fff; }
.setup-input:focus { outline: none; border-color: var(--blue); }
.connect-btn { background: var(--blue); color: #fff; border: none; padding: 10px 20px; font-family: 'Montserrat', sans-serif; font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; border-radius: 2px; transition: background 0.15s; white-space: nowrap; }
.connect-btn:hover { background: var(--blue-dark); }
.connected-badge { display: inline-flex; align-items: center; gap: 6px; background: #e8f5ee; border: 1px solid #a8d5b5; padding: 6px 14px; border-radius: 20px; font-size: 12px; color: #2d7a4f; margin-bottom: 16px; }
hr.sep { border: none; border-top: 1px solid var(--border); margin: 28px 0; }

@media (max-width: 600px) {
  header { padding: 20px; }
  .form-wrap, .admin-wrap { padding: 32px 16px; }
}
</style>
</head>
<body>

<header>
  <div class="logo">Internality</div>
  <button class="admin-btn" onclick="openPasswordModal()">Admin ↗</button>
</header>

<!-- PASSWORD MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box">
    <h3 id="modal-title">Admin Access</h3>
    <p id="modal-subtitle">Enter your password to continue.</p>
    <input type="password" class="modal-input" id="modal-pw" placeholder="Password">
    <input type="password" class="modal-input" id="modal-pw2" placeholder="Confirm password" style="display:none;">
    <div class="modal-error" id="modal-error"></div>
    <button class="modal-submit" onclick="handlePassword()">Continue →</button>
    <button class="modal-cancel" onclick="closePasswordModal()">Cancel</button>
  </div>
</div>

<!-- FORM -->
<div id="view-form" class="view active">
  <div class="form-wrap">
    <div class="form-eyebrow" id="f-eyebrow">Internality Website</div>
    <h1 class="form-headline" id="f-headline">We'd value <em>your perspective.</em></h1>
    <div class="divider"></div>
    <p class="form-intro" id="f-intro">Three brief questions about our website. Your input helps us communicate more effectively.</p>

    <div class="q-block">
      <div class="q-num">Your Name <span style="color:#c0392b">*</span></div>
      <input type="text" id="f-name" placeholder="Name &amp; Title">
      <div class="field-error" id="name-err">Please enter your name to continue.</div>
    </div>

    <div id="questions-container"></div>

    <button class="submit-btn" id="submit-btn" onclick="submitForm()">Submit Feedback →</button>
  </div>
</div>

<!-- THANK YOU -->
<div id="view-thanks" class="view">
  <div class="thankyou">
    <div class="mark">✦</div>
    <h2>Thank you.</h2>
    <p id="thanks-msg">Your feedback has been received. We appreciate you taking the time.</p>
  </div>
</div>

<!-- ADMIN -->
<div id="view-admin" class="view">
  <div class="admin-wrap">
    <div class="admin-top">
      <div>
        <button class="back-btn" onclick="goForm()">← Back to form</button>
        <h2>Admin Dashboard</h2>
      </div>
      <div class="admin-actions">
        <button class="export-btn" onclick="exportCSV()">↓ Export CSV</button>
        <div class="tabs">
          <button class="tab active" id="tab-responses" onclick="switchTab('responses')">Responses</button>
          <button class="tab" id="tab-content"   onclick="switchTab('content')">Content</button>
          <button class="tab" id="tab-questions" onclick="switchTab('questions')">Questions</button>
          <button class="tab" id="tab-setup"     onclick="switchTab('setup')">Setup</button>
        </div>
      </div>
    </div>

    <div class="panel active" id="panel-responses">
      <div class="resp-count" id="resp-count"></div>
      <div id="resp-list"></div>
    </div>

    <div class="panel" id="panel-content">
      <div style="max-width:580px;">
        <div class="editor-card">
          <div class="editor-head"><div class="editor-label">Eyebrow label</div><span class="editor-badge">Small text above headline</span></div>
          <input class="editor-input" id="c-eyebrow" placeholder="e.g. Internality Website">
        </div>
        <div class="editor-card">
          <div class="editor-head"><div class="editor-label">Headline</div><span class="editor-badge">Main heading</span></div>
          <input class="editor-input" id="c-headline" placeholder="e.g. We'd value your perspective.">
        </div>
        <div class="editor-card">
          <div class="editor-head"><div class="editor-label">Intro paragraph</div><span class="editor-badge">Below headline</span></div>
          <textarea class="editor-input" id="c-intro" rows="3" style="resize:vertical;"></textarea>
        </div>
        <div class="editor-card">
          <div class="editor-head"><div class="editor-label">Thank you message</div><span class="editor-badge">After submission</span></div>
          <textarea class="editor-input" id="c-thanks" rows="3" style="resize:vertical;"></textarea>
        </div>
        <button class="save-btn" onclick="saveContent()">Save Content</button>
        <span class="saved-msg" id="saved-content">✓ Saved</span>
      </div>
    </div>

    <div class="panel" id="panel-questions">
      <div id="q-editor"></div>
      <button class="add-q-btn" onclick="addQuestion()">+ Add Question</button>
      <br>
      <button class="save-btn" onclick="saveQuestions()">Save Questions</button>
      <span class="saved-msg" id="saved-questions">✓ Saved</span>
    </div>

    <div class="panel" id="panel-setup">
      <div style="max-width:580px;">
        <div class="setup-banner">
          <strong>Connect to Google Sheets</strong><br><br>
          <strong>1.</strong> Open <a href="https://sheets.google.com" target="_blank">Google Sheets</a> → create a new spreadsheet.<br>
          <strong>2.</strong> Click <strong>Extensions → Apps Script</strong>.<br>
          <strong>3.</strong> Delete all code, paste in <code>google-apps-script.js</code>.<br>
          <strong>4.</strong> Click <strong>Deploy → New deployment → Web app</strong>.<br>
          <strong>5.</strong> Set "Who has access" to <strong>Anyone</strong> → Deploy &amp; authorize.<br>
          <strong>6.</strong> Copy the Web App URL and paste below.
        </div>
        <div id="sheet-status"></div>
        <div class="setup-row">
          <input class="setup-input" id="sheet-url" placeholder="https://script.google.com/macros/s/…/exec">
          <button class="connect-btn" onclick="saveSheetURL()">Connect</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:8px;">Stored in your browser only.</p>
        <hr class="sep">
        <div class="editor-label" style="margin-bottom:12px;">Change Admin Password</div>
        <div class="setup-row">
          <input type="password" class="setup-input" id="new-pw" placeholder="New password">
          <button class="connect-btn" onclick="updatePassword()">Update</button>
        </div>
        <div id="pw-saved" style="font-size:12px;color:#2d7a4f;margin-top:8px;display:none;">✓ Password updated</div>
      </div>
    </div>
  </div>
</div>

<script>
// ── KEYS ──
const K = {
  q:   'int_q_v4',
  r:   'int_responses',
  c:   'int_content',
  pw:  'int_pw',
  url: 'int_sheet_url'
};

const SHEET_HARDCODED = '';

const DEFAULT_Q = [
  { id:'q1', text:'How clearly did the website communicate the value of Internality?', type:'scale', scaleMin:'Not at all clear', scaleMax:'Extremely clear' },
  { id:'q2', text:'What, if anything, was unclear or missing from what you saw?', type:'text' },
  { id:'q3', text:'How likely are you to explore Internality further?', type:'scale', scaleMin:'Not likely', scaleMax:'Very likely' }
];

const DEFAULT_C = {
  eyebrow:  'Internality Website',
  headline: "We'd value <em>your perspective.</em>",
  intro:    'Three brief questions about our website. Your input helps us communicate more effectively.',
  thanks:   'Your feedback has been received. We appreciate you taking the time.'
};

// ── LOAD / SAVE ──
function ls(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e) { return fallback; } }
function ss(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }

let Qs = ls(K.q, JSON.parse(JSON.stringify(DEFAULT_Q)));
let Rs = ls(K.r, []);
let C  = ls(K.c, { ...DEFAULT_C });
let A  = {}; // current form answers

function getSheetURL() { return SHEET_HARDCODED || localStorage.getItem(K.url) || ''; }
function getPW()       { return localStorage.getItem(K.pw) || ''; }

// ── RENDER FORM ──
function renderForm() {
  document.getElementById('f-eyebrow').textContent  = C.eyebrow;
  document.getElementById('f-headline').innerHTML   = C.headline;
  document.getElementById('f-intro').textContent    = C.intro;
  document.getElementById('thanks-msg').textContent = C.thanks;
  document.getElementById('f-name').value = '';
  document.getElementById('name-err').style.display = 'none';
  A = {};

  const wrap = document.getElementById('questions-container');
  wrap.innerHTML = '';
  Qs.forEach((q, i) => {
    const div = document.createElement('div');
    div.className = 'q-block';
    let inp = '';
    if (q.type === 'scale') {
      let btns = '';
      for (let n=1;n<=5;n++) btns += `<button class="scale-btn" data-qid="${q.id}" onclick="pickScale('${q.id}',${n},this)">${n}</button>`;
      inp = `<div class="scale-row">${btns}</div>
             <div class="scale-labels"><span>${q.scaleMin||'Low'}</span><span>${q.scaleMax||'High'}</span></div>
             <div class="opt-label">Comment (optional)</div>
             <textarea rows="2" placeholder="Any additional thoughts…" oninput="A['${q.id}_c']=this.value"></textarea>`;
    } else if (q.type === 'short') {
      inp = `<input type="text" placeholder="Your answer…" oninput="A['${q.id}']=this.value">`;
    } else {
      inp = `<textarea rows="4" placeholder="Your response…" oninput="A['${q.id}']=this.value"></textarea>`;
    }
    div.innerHTML = `<div class="q-num">Question ${i+1}</div><div class="q-text">${q.text}</div>${inp}`;
    wrap.appendChild(div);
  });
}

function pickScale(qId, val, btn) {
  A[qId] = val;
  document.querySelectorAll(`[data-qid="${qId}"]`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// ── SUBMIT ──
async function submitForm() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) {
    document.getElementById('name-err').style.display = 'block';
    document.getElementById('f-name').focus();
    return;
  }
  document.getElementById('name-err').style.display = 'none';
  const btn = document.getElementById('submit-btn');
  btn.disabled = true; btn.textContent = 'Sending…';

  const entry = { name, date: new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}), answers:{} };
  const payload = { name };
  Qs.forEach(q => {
    if (q.type === 'scale') {
      entry.answers[q.id] = { score: A[q.id]||null, comment: A[q.id+'_c']||'' };
      payload[q.id+'_score']   = A[q.id]||null;
      payload[q.id+'_comment'] = A[q.id+'_c']||'';
    } else {
      entry.answers[q.id] = { text: A[q.id]||'' };
      payload[q.id+'_text'] = A[q.id]||'';
    }
  });
  Rs.push(entry); ss(K.r, Rs);

  const url = getSheetURL();
  if (url) {
    try { await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }
    catch(e) { console.warn(e); }
  }
  btn.disabled = false; btn.innerHTML = 'Submit Feedback →';
  showView('view-thanks');
}

// ── PASSWORD MODAL ──
function openPasswordModal() {
  const hasPw = !!getPW();
  document.getElementById('modal-title').textContent    = hasPw ? 'Admin Access' : 'Set Admin Password';
  document.getElementById('modal-subtitle').textContent = hasPw ? 'Enter your password to continue.' : 'Choose a password to protect your admin panel.';
  document.getElementById('modal-pw').value  = '';
  document.getElementById('modal-pw2').value = '';
  document.getElementById('modal-pw2').style.display = hasPw ? 'none' : 'block';
  document.getElementById('modal-error').textContent = '';
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('modal-pw').focus(), 100);
}
function closePasswordModal() { document.getElementById('modal-overlay').classList.remove('open'); }
function handlePassword() {
  const pw  = document.getElementById('modal-pw').value;
  const pw2 = document.getElementById('modal-pw2').value;
  const err = document.getElementById('modal-error');
  const stored = getPW();
  if (!stored) {
    if (!pw)       { err.textContent='Please enter a password.'; return; }
    if (pw !== pw2){ err.textContent='Passwords do not match.';  return; }
    localStorage.setItem(K.pw, pw);
    closePasswordModal(); openAdmin();
  } else {
    if (pw !== stored) { err.textContent='Incorrect password.'; document.getElementById('modal-pw').value=''; return; }
    closePasswordModal(); openAdmin();
  }
}
document.addEventListener('keydown', e => {
  if (e.key==='Enter' && document.getElementById('modal-overlay').classList.contains('open')) handlePassword();
});

// ── ADMIN: RESPONSES ──
function renderResponses() {
  const list  = document.getElementById('resp-list');
  const count = document.getElementById('resp-count');
  const conn  = !!getSheetURL();
  count.innerHTML = `<strong>${Rs.length}</strong> response${Rs.length!==1?'s':''} · ${conn?'<span style="color:#2d7a4f">✓ Google Sheets connected</span>':'<span style="color:var(--muted)">Google Sheets not connected</span>'}`;
  if (!Rs.length) {
    list.innerHTML = `<div class="empty"><div style="font-size:32px;margin-bottom:12px;">✦</div><h3>No responses yet</h3><p>Responses appear here once people submit.</p></div>`;
    return;
  }
  list.innerHTML = '';
  [...Rs].reverse().forEach(r => {
    const card = document.createElement('div');
    card.className = 'resp-card';
    let body = '';
    Qs.forEach(q => {
      const a = r.answers[q.id]; if (!a) return;
      let aHTML = '';
      if (q.type==='scale') {
        aHTML = `<span class="resp-score">${a.score||'—'}</span><span style="font-size:13px;color:var(--muted)"> / 5</span>`;
        if (a.comment) aHTML += `<div style="font-size:13px;color:var(--muted);margin-top:4px">${a.comment}</div>`;
      } else { aHTML = a.text||'<span style="color:var(--muted)">No response</span>'; }
      body += `<div class="resp-item"><div class="resp-q">${q.text}</div><div class="resp-a">${aHTML}</div></div>`;
    });
    card.innerHTML = `<div class="resp-head"><div class="resp-name">${r.name}</div><div class="resp-date">${r.date}</div></div>${body}`;
    list.appendChild(card);
  });
}

// ── ADMIN: CONTENT ──
function renderContentEditor() {
  document.getElementById('c-eyebrow').value  = C.eyebrow;
  document.getElementById('c-headline').value = C.headline.replace(/<[^>]+>/g,'');
  document.getElementById('c-intro').value    = C.intro;
  document.getElementById('c-thanks').value   = C.thanks;
}
function saveContent() {
  C.eyebrow  = document.getElementById('c-eyebrow').value;
  C.headline = document.getElementById('c-headline').value;
  C.intro    = document.getElementById('c-intro').value;
  C.thanks   = document.getElementById('c-thanks').value;
  ss(K.c, C);
  renderForm();
  flash('saved-content');
}

// ── ADMIN: QUESTIONS ──
function renderQuestionsEditor() {
  const wrap = document.getElementById('q-editor');
  wrap.innerHTML = '';
  Qs.forEach((q, i) => {
    const card = document.createElement('div');
    card.className = 'editor-card';
    const typeLabel = q.type==='scale' ? '1–5 Scale' : q.type==='short' ? 'Short text' : 'Open text';
    let extra = '';
    if (q.type === 'scale') {
      extra = `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
        <input class="editor-input" id="qmin-${i}" value="${(q.scaleMin||'').replace(/"/g,'&quot;')}" placeholder="Scale label: low end" style="flex:1;margin-bottom:0;">
        <input class="editor-input" id="qmax-${i}" value="${(q.scaleMax||'').replace(/"/g,'&quot;')}" placeholder="Scale label: high end" style="flex:1;margin-bottom:0;">
      </div>`;
    }
    card.innerHTML = `
      <div class="editor-head">
        <div class="editor-label">Question ${i+1}</div>
        <div class="q-actions">
          <span class="editor-badge">${typeLabel}</span>
          ${i>0                  ? `<button class="icon-btn" onclick="moveQ(${i},-1)">↑</button>`:''}
          ${i<Qs.length-1        ? `<button class="icon-btn" onclick="moveQ(${i},1)">↓</button>`:''}
          ${Qs.length>1          ? `<button class="icon-btn del" onclick="deleteQ(${i})">✕</button>`:''}
        </div>
      </div>
      <input class="editor-input" id="qtxt-${i}" value="${q.text.replace(/"/g,'&quot;')}" placeholder="Question text…">
      <select class="type-select" id="qtype-${i}" onchange="changeQType(${i})">
        <option value="short" ${q.type==='short'?'selected':''}>Short text (1 line)</option>
        <option value="text"  ${q.type==='text' ?'selected':''}>Open text (paragraph)</option>
        <option value="scale" ${q.type==='scale'?'selected':''}>Scale (1–5)</option>
      </select>
      ${extra}`;
    wrap.appendChild(card);
  });
}

function collectQ() {
  Qs.forEach((q,i) => {
    const t  = document.getElementById(`qtxt-${i}`);
    const ty = document.getElementById(`qtype-${i}`);
    if (t)  q.text = t.value;
    if (ty) q.type = ty.value;
    if (q.type==='scale') {
      const mn = document.getElementById(`qmin-${i}`);
      const mx = document.getElementById(`qmax-${i}`);
      if (mn) q.scaleMin = mn.value;
      if (mx) q.scaleMax = mx.value;
    }
  });
}
function changeQType(i) { collectQ(); renderQuestionsEditor(); }
function addQuestion() {
  collectQ();
  Qs.push({ id:'q'+Date.now(), text:'', type:'short' });
  renderQuestionsEditor();
  setTimeout(()=>{ const cards=document.querySelectorAll('.editor-card'); if(cards.length) cards[cards.length-1].scrollIntoView({behavior:'smooth',block:'center'}); },80);
}
function deleteQ(i) { collectQ(); Qs.splice(i,1); renderQuestionsEditor(); }
function moveQ(i,dir) {
  collectQ();
  const j=i+dir;
  if(j<0||j>=Qs.length) return;
  [Qs[i],Qs[j]]=[Qs[j],Qs[i]];
  renderQuestionsEditor();
}
function saveQuestions() { collectQ(); ss(K.q,Qs); renderForm(); flash('saved-questions'); }

// ── ADMIN: SETUP ──
function renderSetup() {
  const url = getSheetURL();
  document.getElementById('sheet-url').value = url;
  document.getElementById('sheet-status').innerHTML = url ? `<div class="connected-badge">✓ Connected to Google Sheets</div>` : '';
}
function saveSheetURL() {
  const url = document.getElementById('sheet-url').value.trim();
  if (!url) return;
  localStorage.setItem(K.url, url);
  renderSetup();
}
function updatePassword() {
  const pw = document.getElementById('new-pw').value.trim();
  if (!pw) return;
  localStorage.setItem(K.pw, pw);
  document.getElementById('new-pw').value = '';
  const el = document.getElementById('pw-saved');
  el.style.display='block';
  setTimeout(()=>el.style.display='none',2500);
}

// ── EXPORT CSV ──
function exportCSV() {
  if (!Rs.length) { alert('No responses yet.'); return; }
  const hdrs = ['Name','Date',...Qs.map((q,i)=>`Q${i+1}: ${q.text}`)];
  const rows = [hdrs.map(h=>`"${h}"`).join(',')];
  Rs.forEach(r => {
    const cols = [`"${r.name}"`,`"${r.date}"`];
    Qs.forEach(q => {
      const a = r.answers[q.id]||{};
      if (q.type==='scale') cols.push(`"${a.score||''}${a.comment?' — '+a.comment:''}"`);
      else cols.push(`"${(a.text||'').replace(/"/g,'""')}"`);
    });
    rows.push(cols.join(','));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='internality-feedback.csv'; a.click();
}

// ── NAV ──
function showView(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function openAdmin() { renderResponses(); renderContentEditor(); renderQuestionsEditor(); renderSetup(); showView('view-admin'); }
function goForm() { renderForm(); showView('view-form'); }
function switchTab(name) {
  ['responses','content','questions','setup'].forEach(t => {
    document.getElementById(`panel-${t}`).classList.toggle('active', t===name);
    document.getElementById(`tab-${t}`).classList.toggle('active', t===name);
  });
  if (name==='responses') renderResponses();
  if (name==='content')   renderContentEditor();
  if (name==='questions') renderQuestionsEditor();
  if (name==='setup')     renderSetup();
}
function flash(id) { const el=document.getElementById(id); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2500); }

// ── INIT ──
renderForm();
</script>
</body>
</html>
